<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>The GAME</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google Fonts for modern typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Using 'Poppins' font for a clean, modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Reset and base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #121212;
            font-family: 'Poppins', sans-serif;
            color: #ffffff;
            line-height: 1.6;
            margin: 0;
        }

        .container {
            max-width: 600px;
            margin: 40px auto;
            padding: 20px;
            background-color: #1e1e1e;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        }

        h1 {
            font-size: 1.8em;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            color: #BB86FC;
        }

        #playerControls, #controls, #gameLengthControls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        input[type="text"], select {
            padding: 12px;
            background-color: #2c2c2c;
            color: #ffffff;
            border: 1px solid #444444;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
            width: 100%;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, select:focus {
            border-color: #BB86FC;
        }

        label {
            font-size: 0.9em;
            color: #cccccc;
            margin-bottom: 5px;
        }

        #currentPlayer {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
            color: #ffffff;
        }

        #hintsRemaining {
            font-size: 0.9em;
            text-align: center;
            margin-bottom: 20px;
            color: #cccccc;
        }

        #question {
            font-size: 1.2em;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
            color: #ffffff;
        }

        #choices {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .choice {
            background-color: #2c2c2c;
            color: #ffffff;
            border: 1px solid #444444;
            padding: 15px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s, transform 0.1s, border-color 0.3s;
        }

        .choice:hover {
            background-color: #383838;
            transform: scale(1.02);
            border-color: #BB86FC;
        }

        #feedback {
            font-size: 1em;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        button {
            background-color: #BB86FC;
            color: #ffffff;
            border: none;
            padding: 15px;
            margin: 5px 0;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%;
        }

        button:hover {
            background-color: #9f6bf1;
        }

        button:disabled {
            background-color: #666666;
            cursor: not-allowed;
        }

        #scoreTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
        }

        #scoreTable th, #scoreTable td {
            border: 1px solid #444444;
            padding: 12px;
            text-align: center;
        }

        #scoreTable th {
            background-color: #2c2c2c;
            color: #cccccc;
            font-weight: 600;
        }

        #scoreTable td {
            background-color: #1e1e1e;
        }

        /* Responsive Design */
        @media (min-width: 600px) {
            .container {
                margin: 60px auto;
                padding: 30px;
            }

            #playerControls, #controls, #gameLengthControls {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }

            #playerControls > *, #controls > div, #gameLengthControls > div {
                flex: 1;
                margin-right: 10px;
            }

            #playerControls > *:last-child, #controls > div:last-child, #gameLengthControls > div:last-child {
                margin-right: 0;
            }

            input[type="text"], button, select {
                width: 100%;
            }

            #choices .choice {
                font-size: 1.1em;
            }
        }

        /* Ensuring dropdown menus expand to fit content */
        select {
            min-width: 150px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Interactive Trivia Game</h1>

        <!-- Player Management -->
        <div id="playerControls">
            <input type="text" id="playerNameInput" placeholder="Enter player name">
            <button onclick="addPlayer()">Add Player</button>
        </div>

        <!-- Score Table -->
        <table id="scoreTable">
            <thead>
                <tr>
                    <th>Player</th>
                    <th>Score</th>
                    <th>Hints Left</th>
                </tr>
            </thead>
            <tbody id="scoreTableBody">
            </tbody>
        </table>

        <!-- Game Length Selection -->
        <div id="gameLengthControls">
            <div>
                <label for="gameLengthSelect">Game Length (First to):</label>
                <select id="gameLengthSelect">
                    <option value="5">5 Points</option>
                    <option value="10">10 Points</option>
                    <option value="15">15 Points</option>
                </select>
            </div>
            <button onclick="startGame()">Start Game</button>
        </div>

        <!-- Difficulty and Category Selection -->
        <div id="controls" style="display: none;">
            <div>
                <label for="difficultySelect">Difficulty:</label>
                <select id="difficultySelect" onchange="changeSettings()">
                    <option value="">Any Difficulty</option>
                    <option value="easy">Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
            </div>
            <div>
                <label for="categorySelect">Category:</label>
                <select id="categorySelect" onchange="changeSettings()">
                    <option value="">Any Category</option>
                    <!-- Categories will be populated dynamically -->
                </select>
            </div>
        </div>

        <!-- Current Player Display -->
        <div id="currentPlayer" style="display: none;">Current Player: <span id="currentPlayerName"></span></div>
        <div id="hintsRemaining" style="display: none;">Hints Remaining: <span id="hintsCount"></span></div>

        <div id="question" style="display: none;">Loading question...</div>
        <div id="choices"></div>
        <div id="feedback"></div>
        <button id="hintButton" onclick="useHint()" style="display: none;">Use Hint</button>
        <button id="nextButton" onclick="nextTurn()" disabled style="display: none;">Next Turn</button>
        <!-- Added Refresh Button -->
        <button id="refreshButton" onclick="retryQuestion()" style="display: none;">Refresh Question</button>
    </div>

    <script>
        let players = [];
        let currentPlayerIndex = 0;
        let currentQuestion = {};
        let acceptingAnswers = false;
        let selectedDifficulty = '';
        let selectedCategory = '';
        let targetScore = 5;
        let sessionToken = '';
        let usedQuestionHashes = new Set();

        // Updated categories array with correct IDs and names
        let categories = [
            { id: 9, name: 'General Knowledge' },
            { id: 10, name: 'Entertainment: Books' },
            { id: 11, name: 'Entertainment: Film' },
            { id: 12, name: 'Entertainment: Music' },
            { id: 13, name: 'Entertainment: Musicals & Theatres' },
            { id: 14, name: 'Entertainment: Television' },
            { id: 15, name: 'Entertainment: Video Games' },
            { id: 16, name: 'Entertainment: Board Games' },
            { id: 17, name: 'Science & Nature' },
            { id: 18, name: 'Science: Computers' },
            { id: 19, name: 'Science: Mathematics' },
            { id: 20, name: 'Mythology' },
            { id: 21, name: 'Sports' },
            { id: 22, name: 'Geography' },
            { id: 23, name: 'History' },
            { id: 24, name: 'Politics' },
            { id: 25, name: 'Art' },
            { id: 26, name: 'Celebrities' },
            { id: 27, name: 'Animals' },
            { id: 28, name: 'Vehicles' },
            { id: 29, name: 'Entertainment: Comics' },
            { id: 30, name: 'Science: Gadgets' },
            { id: 31, name: 'Entertainment: Japanese Anime & Manga' },
            { id: 32, name: 'Entertainment: Cartoon & Animations' }
        ];

        // Function to decode HTML entities
        function decodeHTMLEntities(text) {
            var txt = document.createElement('textarea');
            txt.innerHTML = text;
            return txt.value;
        }

        // Function to add a player
        function addPlayer() {
            const playerNameInput = document.getElementById('playerNameInput');
            const playerName = playerNameInput.value.trim();
            if (playerName !== '') {
                players.push({ name: playerName, score: 0, hints: 3 });
                playerNameInput.value = '';
                updateScoreTable();

                // Display the score table when the first player is added
                if (players.length === 1) {
                    document.getElementById('scoreTable').style.display = 'table';
                }
            }
        }

        // Function to update the score table
        function updateScoreTable() {
            const scoreTableBody = document.getElementById('scoreTableBody');
            scoreTableBody.innerHTML = '';
            players.forEach(player => {
                const row = document.createElement('tr');
                const nameCell = document.createElement('td');
                nameCell.innerText = player.name;
                const scoreCell = document.createElement('td');
                scoreCell.innerText = player.score;
                const hintsCell = document.createElement('td');
                hintsCell.innerText = player.hints;
                row.appendChild(nameCell);
                row.appendChild(scoreCell);
                row.appendChild(hintsCell);
                scoreTableBody.appendChild(row);
            });
        }

        // Function to handle settings change
        function changeSettings() {
            selectedDifficulty = document.getElementById('difficultySelect').value;
            selectedCategory = document.getElementById('categorySelect').value;
            nextQuestion();
        }

        // Function to start the game
        async function startGame() {
            if (players.length > 0) {
                targetScore = parseInt(document.getElementById('gameLengthSelect').value);
                document.getElementById('playerControls').style.display = 'none';
                document.getElementById('gameLengthControls').style.display = 'none';
                document.getElementById('controls').style.display = 'flex';
                document.getElementById('currentPlayer').style.display = 'block';
                document.getElementById('hintsRemaining').style.display = 'block';
                document.getElementById('scoreTable').style.display = 'table';
                document.getElementById('hintButton').style.display = 'block';
                document.getElementById('nextButton').style.display = 'block';
                document.getElementById('question').style.display = 'block';
                currentPlayerIndex = 0; // Reset to the first player
                document.getElementById('currentPlayerName').innerText = players[currentPlayerIndex].name;
                document.getElementById('hintsCount').innerText = players[currentPlayerIndex].hints;

                // Reset used questions and get a new session token
                usedQuestionHashes.clear();
                await getSessionToken();

                nextQuestion();
            } else {
                alert('Please add at least one player to start the game.');
            }
        }

        // Function to get a session token from Open Trivia Database API
        async function getSessionToken() {
            try {
                const response = await fetch('https://opentdb.com/api_token.php?command=request');
                const data = await response.json();
                if (data.response_code === 0) {
                    sessionToken = data.token;
                } else {
                    console.error('Error obtaining session token:', data);
                    sessionToken = '';
                }
            } catch (error) {
                console.error('Error fetching session token:', error);
                sessionToken = '';
            }
        }

        // Function to reset the session token
        async function resetSessionToken() {
            try {
                const response = await fetch(`https://opentdb.com/api_token.php?command=reset&token=${sessionToken}`);
                const data = await response.json();
                if (data.response_code === 0) {
                    // Token reset successfully
                } else {
                    console.error('Error resetting session token:', data);
                }
            } catch (error) {
                console.error('Error resetting session token:', error);
            }
        }

        // Function to load a new question
        async function nextQuestion() {
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('nextButton').disabled = true;
            document.getElementById('nextButton').style.display = 'block'; // Ensure "Next Turn" button is visible
            document.getElementById('hintButton').disabled = players[currentPlayerIndex].hints === 0;
            document.getElementById('refreshButton').style.display = 'none';
            acceptingAnswers = false;

            // Update current player display
            document.getElementById('currentPlayerName').innerText = players[currentPlayerIndex].name;
            document.getElementById('hintsCount').innerText = players[currentPlayerIndex].hints;

            // Build the API URL with selected settings
            let apiUrl = `https://opentdb.com/api.php?amount=1&type=multiple`;
            if (sessionToken) {
                apiUrl += `&token=${sessionToken}`;
            }
            if (selectedDifficulty) {
                apiUrl += `&difficulty=${selectedDifficulty}`;
            }
            if (selectedCategory) {
                apiUrl += `&category=${selectedCategory}`;
            }

            // Fetch question from Open Trivia Database API
            try {
                let data;
                let maxAttempts = 5;
                let attempts = 0;
                let uniqueQuestionFound = false;

                while (attempts < maxAttempts && !uniqueQuestionFound) {
                    const response = await fetch(apiUrl);
                    data = await response.json();

                    if (data.response_code === 0 && data.results && data.results.length > 0) {
                        const questionHash = hashQuestion(data.results[0]);
                        if (!usedQuestionHashes.has(questionHash)) {
                            usedQuestionHashes.add(questionHash);
                            currentQuestion = data.results[0];
                            uniqueQuestionFound = true;
                        } else {
                            // Question has already been used, fetch another one
                            attempts++;
                        }
                    } else if (data.response_code === 1) {
                        // No results available
                        showErrorMessage('No questions available for the selected settings. Please try different options.');
                        return;
                    } else if (data.response_code === 4) {
                        // All questions have been exhausted, reset the token
                        await resetSessionToken();
                        usedQuestionHashes.clear();
                        attempts++;
                    } else if (data.response_code === 3) {
                        // Token not found or invalid
                        console.error('Invalid session token. Requesting a new one.');
                        await getSessionToken();
                        attempts++;
                    } else {
                        console.error('Error fetching question:', data);
                        showErrorMessage('An error occurred while fetching the question. Please try again later.');
                        return;
                    }
                }

                if (uniqueQuestionFound) {
                    displayQuestion();
                } else {
                    showErrorMessage('No new questions available. Please try different settings or restart the game.');
                }
            } catch (error) {
                console.error('Error fetching question:', error);
                showErrorMessage('An error occurred while fetching the question. Please check your internet connection.');
            }
        }

        // Function to show error messages and allow game continuation
        function showErrorMessage(message) {
            document.getElementById('question').innerText = message;
            document.getElementById('choices').innerHTML = '';
            document.getElementById('hintButton').style.display = 'none';
            document.getElementById('refreshButton').style.display = 'block';
            document.getElementById('nextButton').style.display = 'none';
            acceptingAnswers = false;
        }

        // Function to retry fetching a question
        function retryQuestion() {
            document.getElementById('refreshButton').style.display = 'none';
            nextQuestion();
        }

        // Function to hash a question object to identify uniqueness
        function hashQuestion(questionObj) {
            const questionString = JSON.stringify(questionObj);
            let hash = 0, i, chr;
            if (questionString.length === 0) return hash;
            for (i = 0; i < questionString.length; i++) {
                chr   = questionString.charCodeAt(i);
                hash  = ((hash << 5) - hash) + chr;
                hash |= 0; // Convert to 32bit integer
            }
            return hash;
        }

        // Function to display the question and choices
        function displayQuestion() {
            const questionText = decodeHTMLEntities(currentQuestion.question);
            document.getElementById('question').innerText = questionText;

            document.getElementById('choices').style.display = 'flex';
            document.getElementById('hintButton').style.display = 'block';
            document.getElementById('refreshButton').style.display = 'none';
            document.getElementById('nextButton').style.display = 'block'; // Ensure "Next Turn" button is visible

            // Combine correct and incorrect answers and shuffle them
            const choices = [...currentQuestion.incorrect_answers];
            choices.push(currentQuestion.correct_answer);
            choices.sort(() => Math.random() - 0.5);

            // Display choices
            const choicesContainer = document.getElementById('choices');
            choicesContainer.innerHTML = '';

            choices.forEach(choice => {
                const choiceButton = document.createElement('button');
                choiceButton.classList.add('choice');
                choiceButton.innerText = decodeHTMLEntities(choice);
                choiceButton.onclick = () => selectAnswer(choice);
                choicesContainer.appendChild(choiceButton);
            });

            acceptingAnswers = true; // Ensure answers are accepted
        }

        // Function to handle answer selection
        function selectAnswer(selectedChoice) {
            if (!acceptingAnswers) return;
            acceptingAnswers = false;

            const feedback = document.getElementById('feedback');
            const correctAnswer = decodeHTMLEntities(currentQuestion.correct_answer);

            if (selectedChoice === currentQuestion.correct_answer) {
                feedback.innerText = 'Correct!';
                feedback.style.color = '#03DAC6';
                // Update player's score
                players[currentPlayerIndex].score += 1;
                updateScoreTable();
                checkForWinner();
            } else {
                feedback.innerText = `Incorrect! The correct answer was: ${correctAnswer}`;
                feedback.style.color = '#CF6679';
            }

            feedback.style.display = 'block';
            document.getElementById('nextButton').disabled = false;
        }

        // Function to use a hint
        async function useHint() {
            if (!acceptingAnswers) return;
            const currentPlayer = players[currentPlayerIndex];

            // Attempt to fetch a hint
            const hintAvailable = await provideHint();

            if (hintAvailable) {
                // Only reduce hint count if a hint was actually provided
                currentPlayer.hints -= 1;
                document.getElementById('hintsCount').innerText = currentPlayer.hints;
                updateScoreTable();

                if (currentPlayer.hints === 0) {
                    document.getElementById('hintButton').disabled = true;
                }
            }
        }

        // Function to provide a hint using Datamuse API
        async function provideHint() {
            const correctAnswer = decodeHTMLEntities(currentQuestion.correct_answer).trim();
            const feedback = document.getElementById('feedback');

            try {
                const relatedWords = await fetchRelatedWords(correctAnswer);
                if (relatedWords.length > 0) {
                    const hints = relatedWords.slice(0, 5).map(wordObj => wordObj.word);
                    feedback.innerText = `Hint: Related words - ${hints.join(', ')}`;
                    feedback.style.color = '#BB86FC';
                    feedback.style.display = 'block';
                    return true; // Hint was provided
                } else {
                    feedback.innerText = 'No hint available for this question.';
                    feedback.style.color = '#BB86FC';
                    feedback.style.display = 'block';
                    return false; // No hint available
                }
            } catch (error) {
                console.error('Error fetching hint:', error);
                feedback.innerText = 'No hint available for this question.';
                feedback.style.color = '#BB86FC';
                feedback.style.display = 'block';
                return false; // No hint available
            }
        }

        // Function to fetch related words from Datamuse API
        async function fetchRelatedWords(searchTerm) {
            const apiUrl = `https://api.datamuse.com/words?rel_trg=${encodeURIComponent(searchTerm)}&max=10`;

            try {
                const response = await fetch(apiUrl);
                if (response.ok) {
                    const data = await response.json();
                    // Filter out any words that are the same as the answer
                    const filteredData = data.filter(wordObj => wordObj.word.toLowerCase() !== searchTerm.toLowerCase());
                    return filteredData;
                }
            } catch (error) {
                console.error('Error fetching related words:', error);
            }
            return [];
        }

        // Function to check for a winner
        function checkForWinner() {
            if (players[currentPlayerIndex].score >= targetScore) {
                // Disable further gameplay
                acceptingAnswers = false;
                document.getElementById('nextButton').disabled = true;
                document.getElementById('hintButton').disabled = true;
                document.getElementById('hintButton').style.display = 'none';
                document.getElementById('nextButton').style.display = 'none';
                document.getElementById('refreshButton').style.display = 'none';
                document.getElementById('question').innerText = `ðŸŽ‰ ${players[currentPlayerIndex].name} wins the game! ðŸŽ‰`;
                document.getElementById('choices').style.display = 'none';
                document.getElementById('feedback').style.display = 'none';
                document.getElementById('currentPlayer').style.display = 'none';
                document.getElementById('hintsRemaining').style.display = 'none';
            }
        }

        // Function to move to the next player's turn
        function nextTurn() {
            if (players.length > 0) {
                currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
                acceptingAnswers = false;
                document.getElementById('hintButton').disabled = players[currentPlayerIndex].hints === 0;
                document.getElementById('currentPlayerName').innerText = players[currentPlayerIndex].name;
                document.getElementById('hintsCount').innerText = players[currentPlayerIndex].hints;
                nextQuestion();
            }
        }

        // Initialize the game (populate categories)
        window.onload = () => {
            // Populate categories in the categorySelect dropdown
            const categorySelect = document.getElementById('categorySelect');
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.innerText = category.name;
                categorySelect.appendChild(option);
            });
        };
    </script>

</body>
</html>
